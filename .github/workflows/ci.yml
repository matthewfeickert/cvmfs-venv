name: CI

on:
  push:
    # branches:
    # - main
  pull_request:
  workflow_dispatch:

jobs:

  test:
    runs-on: ubuntu-latest
    container:
      image: gitlab-registry.cern.ch/atlas/athena/analysisbase:22.2.113
      volumes:
        - ${{ github.workspace }}:/github-workspace
      options: --workdir /workdir
    defaults:
      run:
        shell: bash
        working-directory: /workdir

    steps:
      # AnalysisBase Git version is too old to use modern checkout action
    - uses: actions/checkout@v1

    - name: Check runtime information
      run: |
        echo "CWD=$(pwd)"
        ls -lhtra /
        cp /github-workspace/cvmfs-venv.sh .
        echo "ls -lhtra:"
        ls -lhtra
        echo "env:"
        env
        echo "id:"
        id
        echo 'export PATH=~/.local/bin:"${PATH}"' > ~/.bashrc

    - name: Install cvmfs-venv locally
      run: |
        mkdir -p /home/atlas/.local/bin
        cp cvmfs-venv.sh /home/atlas/.local/bin/cvmfs-venv
        export PATH="/home/atlas/.local/bin:${PATH}"
        command -v cvmfs-venv
        echo "${PATH}"

    - name: Setup venv using /release_setup.sh
      run: |
        . cvmfs-venv.sh
        echo "PATH=${PATH}"
        echo "PYTHONPATH=${PYTHONPATH}"

    - name: List installed Python packages
      run: |
        python -m pip list
        python -m pip list --local

    - name: Update NumPy and install Uproot
      run: |
        python -m pip install --upgrade numpy uproot
        python -m pip list
        python -m pip list --local

    - name: Deactivate environment
      run: |
        deactivate
        echo "PATH=${PATH}"
        echo "PYTHONPATH=${PYTHONPATH}"
        python -m pip list

    - name: Reactivate environment
      run: |
        . venv/bin/activate
        echo "PATH=${PATH}"
        echo "PYTHONPATH=${PYTHONPATH}"
        python -m pip list
        python -m pip list --local

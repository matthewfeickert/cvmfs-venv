name: CI

on:
  push:
    # branches:
    # - main
  pull_request:
  workflow_dispatch:

jobs:

  test:
    runs-on: ubuntu-latest
    container:
      image: gitlab-registry.cern.ch/atlas/athena/analysisbase:22.2.113
      # volumes:
      #  - ${{ github.workspace }}:/github-workspace
      # options: --workdir /workdir
    env:
      HOME: /home/atlas
    defaults:
      run:
        shell: bash
        working-directory: /workdir

    steps:
      # AnalysisBase Git version is too old to use modern checkout action
    - uses: actions/checkout@v1

    - name: Check runtime information
      run: |
        echo "CWD=$(pwd)"
        ls -lhtra
        # ls -lhtra /github-workspace
        echo "ls -lhtra /__w"
        ls -lhtra /__w
        ls -lhtra /__w/cvmfs-venv/cvmfs-venv
        # cp /github-workspace/* .
        cp -r /__w/cvmfs-venv/cvmfs-venv/cvmfs-venv.sh .
        echo "ls -lhtra:"
        ls -lhtra
        echo "env:"
        env
        echo "id:"
        id
        echo 'export PATH=/home/atlas/.local/bin:"${PATH}"' > /home/atlas/.bashrc

    - name: Place ~/.local/bin on PATH
      run: |
        mkdir -p /home/atlas/.local/bin
        echo "PATH=/home/atlas/.local/bin:${PATH}" >> $GITHUB_ENV

    - name: Install cvmfs-venv locally
      run: |
        cp cvmfs-venv.sh /home/atlas/.local/bin/cvmfs-venv
        command -v cvmfs-venv
        echo "${PATH}"

    - name: Setup venv using /release_setup.sh
      run: |
        . cvmfs-venv.sh
        echo "PATH=${PATH}"
        echo "PYTHONPATH=${PYTHONPATH}"

    - name: List installed Python packages
      run: |
        . /release_setup.sh
        . venv/bin/activate
        python -m pip list
        python -m pip list --local

    - name: Update NumPy and install Uproot
      run: |
        . /release_setup.sh
        . venv/bin/activate
        python -m pip install --upgrade numpy uproot
        python -m pip list
        python -m pip list --local

    - name: Deactivate environment
      run: |
        . /release_setup.sh
        . venv/bin/activate
        deactivate
        echo "PATH=${PATH}"
        echo "PYTHONPATH=${PYTHONPATH}"
        python -m pip list

    - name: Reactivate environment
      run: |
        . venv/bin/activate
        echo "PATH=${PATH}"
        echo "PYTHONPATH=${PYTHONPATH}"
        python -m pip list
        python -m pip list --local
